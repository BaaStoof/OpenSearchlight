/*! Opensearchlight - v0.2.1 - 2012-12-10
* https://github.com/nsidc/OpenSearchlight
* Copyright (c) 2012 Regents of the University of Colorado; Licensed MIT */
var OpenSearchlight=OpenSearchlight||{};(function(){function a(a){var b=[];return _.isArray(a)?a:(b.push(a),b)}OpenSearchlight.query=function(a){var b;OpenSearchlight.ensureParamsNotEmpty(a),OpenSearchlight.ensureParamsHasOsdd(a),OpenSearchlight.ensureParamsHasSuccessHandler(a),b=OpenSearchlight.generateOsddSuccessFn(a),OpenSearchlight.openSearchService.query(a.osdd,b)},OpenSearchlight.generateOsddSuccessFn=function(a){return function(b){var c;a instanceof Object&&(_.each(a.parameters,function(a,c){b.set(c,a)}),a.contentType!==undefined&&b.setContentType(a.contentType)),c=OpenSearchlight.extendWith({},a,["success","error"]),b.execute(c)}},OpenSearchlight.extendWith=function(b,c,d){var e=_.extend(b),f=[];return typeof c!="object"?b:(f=a(d),_.each(f,function(a){c.hasOwnProperty(a)&&(e[a]=c[a])}),e)},OpenSearchlight.ensureParamsNotEmpty=function(a){if(a===undefined)throw new Error("Must pass a params object")},OpenSearchlight.ensureParamsHasOsdd=function(a){if(typeof a.osdd!="string")throw new Error("Must pass an osdd value in the params object")},OpenSearchlight.ensureParamsHasSuccessHandler=function(a){if(typeof a.success!="function")throw new Error("Must pass a success handler in the params object")}})(),function(a,b){var c;c=OpenSearchlight.OpenSearchQuery=function(){this.initialize.apply(this,arguments)},b.extend(c.prototype,{initialize:function(a){if(arguments.length===0)throw new Error("Must pass OSDD's XML");if(a instanceof OpenSearchlight.OpenSearchDescriptionDocument)this.openSearchDescriptionDocument=a;else if(typeof a=="string")this.openSearchDescriptionDocument=this.createOpenSearchDescriptionDocument(a);else throw new Error("Invalid argument to OpenSearchQuery");this.searchParams={}},set:function(a,b){return this.searchParams[a]=b,this},setContentType:function(a){return this.contentType=a,this},execute:function(b){var c=this.openSearchDescriptionDocument.getQueryUrl(this.getParams(),this.getContentType());a.ajax({url:c,success:function(a,c,d){b.success(d.responseText)},error:b.error})},get:function(a){return this.searchParams[a]},getContentType:function(){return this.contentType},getParams:function(){return this.searchParams},createOpenSearchDescriptionDocument:function(a){return new OpenSearchlight.OpenSearchDescriptionDocument(a)}}),b.extend(c,{})}(jQuery,_),function(a,b){OpenSearchlight.openSearchService={query:function(c,d){a.ajax({url:c,success:b.bind(function(a,b,c){d.call(this,this.createQueryObject(c.responseText))},this)})},createQueryObject:function(a){return new OpenSearchlight.OpenSearchQuery(a)}}}(jQuery,_),function(a,b){var c;c=OpenSearchlight.OpenSearchDescriptionDocument=function(a){this.initialize.apply(this,arguments)},b.extend(c.prototype,{initialize:function(a){if(!c.validate(a))throw new Error("Error parsing xml");this.osddXml=a},getQueryUrl:function(a,b){var d,e,f;return d=c.extractTemplateUrls(this.osddXml),e=c.getBestTemplate(d,b,a),f=c.substituteTemplateParameters(e,a),f}}),b.extend(c,{validate:function(a){return a?a.match(/http:\/\/a9.com\/-\/spec\/opensearch\/1.1\//)?!0:!1:!1},extractTemplateUrls:function(b){var c=[],d=a(b).find("url[rel!=self]");return d.each(function(a,b){c.push({type:this.getAttribute("type"),template:this.getAttribute("template")})}),c.length===0?undefined:c},getBestTemplate:function(a,b,d){var e,f,g;return e=c.filterUrlTemplatesOnMimeType(a,b),f=c.filterUrlTemplatesWithMissingRequiredParams(e,d),g=c.findTemplateWithMostParamMatches(f,d),g.template},filterUrlTemplatesOnMimeType:function(a,d){return b.filter(a,function(a){return c.doesContentTypeMatch(d,a.type)})},doesContentTypeMatch:function(a,b){var c,d;return a==="*/*"?!0:a===b?!0:(c=a.split("/"),d=b.split("/"),c[0]===d[0]&&c[1]==="*"?!0:c[0]==="*"&&c[1]===d[1]?!0:!1)},filterUrlTemplatesWithMissingRequiredParams:function(a,d){return b.filter(a,function(a){return c.areAllRequiredParamsPresent(a,d)})},areAllRequiredParamsPresent:function(a,c){var d,e;return d=b.map(a.template.match(/\{.*?[^?]\}/g),function(a){return a.replace(/[{}]/g,"")}),e=b.keys(c),b.difference(d,e).length===0},findTemplateWithMostParamMatches:function(a,d){var e=b.sortBy(a,function(a){return c.countMatchingParams(d,a.template)});return b.last(e)},countMatchingParams:function(a,c){var d;return d=b.map(c.match(/\{.*?\}/g),function(a){return a.replace(/[{}]/g,"")}),b.reduce(d,function(b,c){return a[c]===undefined?b:b+1},0)},substituteTemplateParameters:function(a,c){var d=a;return b.each(c,function(a,b){d=d.replace(new RegExp("{"+b+"\\??}"),a)}),d=d.replace(/\{.*?\?\}/g,""),d}})}(jQuery,_);