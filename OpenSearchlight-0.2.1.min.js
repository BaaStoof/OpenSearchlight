/*! Opensearchlight - v0.2.1 - 2013-02-17
* https://github.com/nsidc/OpenSearchlight
* Copyright (c) 2013 Regents of the University of Colorado; Licensed MIT */
var OpenSearchlight=OpenSearchlight||{};(function(){function e(e){var t=[];return _.isArray(e)?e:(t.push(e),t)}OpenSearchlight.query=function(e){var t;OpenSearchlight.ensureParamsNotEmpty(e),OpenSearchlight.ensureParamsHasOsdd(e),OpenSearchlight.ensureParamsHasSuccessHandler(e),t=OpenSearchlight.generateOsddSuccessFn(e),OpenSearchlight.openSearchService.query(e.osdd,t)},OpenSearchlight.generateOsddSuccessFn=function(e){return function(t){var n;e instanceof Object&&(_.each(e.parameters,function(e,n){t.set(n,e)}),e.contentType!==undefined&&t.setContentType(e.contentType)),n=OpenSearchlight.extendWith({},e,["success","error"]),t.execute(n)}},OpenSearchlight.extendWith=function(t,n,r){var i=_.extend(t),s=[];return typeof n!="object"?t:(s=e(r),_.each(s,function(e){n.hasOwnProperty(e)&&(i[e]=n[e])}),i)},OpenSearchlight.ensureParamsNotEmpty=function(e){if(e===undefined)throw new Error("Must pass a params object")},OpenSearchlight.ensureParamsHasOsdd=function(e){if(typeof e.osdd!="string")throw new Error("Must pass an osdd value in the params object")},OpenSearchlight.ensureParamsHasSuccessHandler=function(e){if(typeof e.success!="function")throw new Error("Must pass a success handler in the params object")}})(),function(e,t){var n;n=OpenSearchlight.OpenSearchQuery=function(){this.initialize.apply(this,arguments)},t.extend(n.prototype,{initialize:function(e){if(arguments.length===0)throw new Error("Must pass OSDD's XML");if(e instanceof OpenSearchlight.OpenSearchDescriptionDocument)this.openSearchDescriptionDocument=e;else{if(typeof e!="string")throw new Error("Invalid argument to OpenSearchQuery");this.openSearchDescriptionDocument=this.createOpenSearchDescriptionDocument(e)}this.searchParams={}},set:function(e,t){return this.searchParams[e]=t,this},setContentType:function(e){return this.contentType=e,this},execute:function(t){var n=this.openSearchDescriptionDocument.getQueryUrl(this.getParams(),this.getContentType());e.ajax({url:n,success:function(e,n,r){t.success(r.responseText)},error:t.error})},get:function(e){return this.searchParams[e]},getContentType:function(){return this.contentType},getParams:function(){return this.searchParams},createOpenSearchDescriptionDocument:function(e){return new OpenSearchlight.OpenSearchDescriptionDocument(e)}}),t.extend(n,{})}(jQuery,_),function(e,t){OpenSearchlight.openSearchService={query:function(n,r){e.ajax({url:n,success:t.bind(function(e,t,n){r.call(this,this.createQueryObject(n.responseText))},this)})},createQueryObject:function(e){return new OpenSearchlight.OpenSearchQuery(e)}}}(jQuery,_),function(e,t){var n;n=OpenSearchlight.OpenSearchDescriptionDocument=function(e){this.initialize.apply(this,arguments)},t.extend(n.prototype,{initialize:function(e){if(!n.validate(e))throw new Error("Error parsing xml");this.osddXml=e},getQueryUrl:function(e,t){var r,i,s;return r=n.extractTemplateUrls(this.osddXml),i=n.getBestTemplate(r,t,e),s=n.substituteTemplateParameters(i,e),s}}),t.extend(n,{validate:function(e){return e?e.match(/http:\/\/a9.com\/-\/spec\/opensearch\/1.1\//)?!0:!1:!1},extractTemplateUrls:function(t){var n=[],r=e(t).find("url[rel!=self]");return r.each(function(e,t){n.push({type:this.getAttribute("type"),template:this.getAttribute("template")})}),n.length===0?undefined:n},getBestTemplate:function(e,t,r){var i,s,o;return i=n.filterUrlTemplatesOnMimeType(e,t),s=n.filterUrlTemplatesWithMissingRequiredParams(i,r),o=n.findTemplateWithMostParamMatches(s,r),o.template},filterUrlTemplatesOnMimeType:function(e,r){return t.filter(e,function(e){return n.doesContentTypeMatch(r,e.type)})},doesContentTypeMatch:function(e,t){var n,r;return e==="*/*"?!0:e===t?!0:(n=e.split("/"),r=t.split("/"),n[0]===r[0]&&n[1]==="*"?!0:n[0]==="*"&&n[1]===r[1]?!0:!1)},filterUrlTemplatesWithMissingRequiredParams:function(e,r){return t.filter(e,function(e){return n.areAllRequiredParamsPresent(e,r)})},areAllRequiredParamsPresent:function(e,n){var r,i,s;return r=t.map(e.template.match(/\{[^}]*\}/g),function(e){return e.replace(/[{}]/g,"")}),i=t.filter(r,function(e){return e.substring(e.length-1)!=="?"}),s=t.keys(n),t.difference(i,s).length===0},XareAllRequiredParamsPresent:function(e,n){var r,i;return r=t.map(e.template.match(/\{.*?[^?]\}/g),function(e){return e.replace(/[{}]/g,"")}),i=t.keys(n),t.difference(r,i).length===0},findTemplateWithMostParamMatches:function(e,r){var i=t.sortBy(e,function(e){return n.countMatchingParams(r,e.template)});return t.last(i)},countMatchingParams:function(e,n){var r;return r=t.map(n.match(/\{.*?\}/g),function(e){return e.replace(/[{}]/g,"")}),t.reduce(r,function(t,n){return e[n]===undefined?t:t+1},0)},substituteTemplateParameters:function(e,n){var r=e;return t.each(n,function(e,t){r=r.replace(new RegExp("{"+t+"\\??}"),e)}),r=r.replace(/\{.*?\?\}/g,""),r}})}(jQuery,_);