/*! Opensearchlight - v0.2.3 - 2013-05-03
* https://github.com/nsidc/OpenSearchlight
* Copyright (c) 2013 Regents of the University of Colorado; Licensed MIT
*/
var OpenSearchlight=OpenSearchlight||{};(function(){function e(e){var t=[];return _.isArray(e)?e:(t.push(e),t)}OpenSearchlight.query=function(e){var t;OpenSearchlight.ensureParamsNotEmpty(e),OpenSearchlight.ensureParamsHasOsdd(e),OpenSearchlight.ensureParamsHasSuccessHandler(e),t=OpenSearchlight.generateOsddSuccessFn(e),OpenSearchlight.openSearchService.query(e.osdd,t)},OpenSearchlight.generateOsddSuccessFn=function(e){return function(t){var r;e instanceof Object&&(_.each(e.parameters,function(e,r){t.set(r,e)}),void 0!==e.contentType&&t.setContentType(e.contentType)),r=OpenSearchlight.extendWith({},e,["success","error","queryXhr"]),t.execute(r)}},OpenSearchlight.extendWith=function(t,r,n){var a=_.extend(t),i=[];return"object"!=typeof r?t:(i=e(n),_.each(i,function(e){r.hasOwnProperty(e)&&(a[e]=r[e])}),a)},OpenSearchlight.ensureParamsNotEmpty=function(e){if(void 0===e)throw Error("Must pass a params object")},OpenSearchlight.ensureParamsHasOsdd=function(e){if("string"!=typeof e.osdd)throw Error("Must pass an osdd value in the params object")},OpenSearchlight.ensureParamsHasSuccessHandler=function(e){if("function"!=typeof e.success)throw Error("Must pass a success handler in the params object")}})(),function(e,t){var r;r=OpenSearchlight.OpenSearchQuery=function(){this.initialize.apply(this,arguments)},t.extend(r.prototype,{initialize:function(e){if(0===arguments.length)throw Error("Must pass OSDD's XML");if(e instanceof OpenSearchlight.OpenSearchDescriptionDocument)this.openSearchDescriptionDocument=e;else{if("string"!=typeof e)throw Error("Invalid argument to OpenSearchQuery");this.openSearchDescriptionDocument=this.createOpenSearchDescriptionDocument(e)}this.searchParams={}},set:function(e,t){return this.searchParams[e]=t,this},setContentType:function(e){return this.contentType=e,this},execute:function(t){var r=this.openSearchDescriptionDocument.getQueryUrl(this.getParams(),this.getContentType()),n=e.ajax({url:r,success:function(e,r,n){t.success(n)},error:t.error});void 0!==t.queryXhr&&t.queryXhr(n)},get:function(e){return this.searchParams[e]},getContentType:function(){return this.contentType},getParams:function(){return this.searchParams},createOpenSearchDescriptionDocument:function(e){return new OpenSearchlight.OpenSearchDescriptionDocument(e)}}),t.extend(r,{})}(jQuery,_),function(e,t){OpenSearchlight.openSearchService={query:function(r,n){e.ajax({url:r,success:t.bind(function(e,t,r){n.call(this,this.createQueryObject(r.responseText))},this)})},createQueryObject:function(e){return new OpenSearchlight.OpenSearchQuery(e)}}}(jQuery,_),function(e,t){var r;r=OpenSearchlight.OpenSearchDescriptionDocument=function(){this.initialize.apply(this,arguments)},t.extend(r.prototype,{initialize:function(e){if(!r.validate(e))throw Error("Error parsing xml");this.osddXml=e},getQueryUrl:function(e,t){var n,a,i;return n=r.extractTemplateUrls(this.osddXml),a=r.getBestTemplate(n,t,e),i=r.substituteTemplateParameters(a,e)}}),t.extend(r,{validate:function(e){return e?e.match(/http:\/\/a9.com\/-\/spec\/opensearch\/1.1\//)?!0:!1:!1},extractTemplateUrls:function(t){var r=[],n=e(t).find("url[rel!=self]");return n.each(function(){r.push({type:this.getAttribute("type"),template:this.getAttribute("template")})}),0===r.length?void 0:r},getBestTemplate:function(e,t,n){var a,i,c;return a=r.filterUrlTemplatesOnMimeType(e,t),i=r.filterUrlTemplatesWithMissingRequiredParams(a,n),c=r.findTemplateWithMostParamMatches(i,n),c.template},filterUrlTemplatesOnMimeType:function(e,n){return t.filter(e,function(e){return r.doesContentTypeMatch(n,e.type)})},doesContentTypeMatch:function(e,t){var r,n;return"*/*"===e?!0:e===t?!0:(r=e.split("/"),n=t.split("/"),r[0]===n[0]&&"*"===r[1]?!0:"*"===r[0]&&r[1]===n[1]?!0:!1)},filterUrlTemplatesWithMissingRequiredParams:function(e,n){return t.filter(e,function(e){return r.areAllRequiredParamsPresent(e,n)})},areAllRequiredParamsPresent:function(e,r){var n,a,i;return n=t.map(e.template.match(/\{[^}]*\}/g),function(e){return e.replace(/[{}]/g,"")}),a=t.filter(n,function(e){return"?"!==e.substring(e.length-1)}),i=t.keys(r),0===t.difference(a,i).length},XareAllRequiredParamsPresent:function(e,r){var n,a;return n=t.map(e.template.match(/\{.*?[^?]\}/g),function(e){return e.replace(/[{}]/g,"")}),a=t.keys(r),0===t.difference(n,a).length},findTemplateWithMostParamMatches:function(e,n){var a=t.sortBy(e,function(e){return r.countMatchingParams(n,e.template)});return t.last(a)},countMatchingParams:function(e,r){var n;return n=t.map(r.match(/\{.*?\}/g),function(e){return e.replace(/[{}]/g,"")}),t.reduce(n,function(t,r){return void 0===e[r]?t:t+1},0)},substituteTemplateParameters:function(e,r){var n=e;return t.each(r,function(e,t){n=n.replace(RegExp("{"+t+"\\??}"),e)}),n=n.replace(/\{.*?\?\}/g,"")}})}(jQuery,_);